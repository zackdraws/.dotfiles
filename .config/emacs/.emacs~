;;; -------------------------------
;;; straight.el bootstrap
;;; -------------------------------
(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name
        "straight/repos/straight.el/bootstrap.el"
        (or (bound-and-true-p straight-base-dir)
            user-emacs-directory)))
      (bootstrap-version 7))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
        (url-retrieve-synchronously
         "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
         'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))

(straight-use-package 'use-package)
(setq straight-use-package-by-default t)

;;; -------------------------------
;;; Core packages
;;; -------------------------------
(straight-use-package 'emacsql)
(straight-use-package 'emacsql-sqlite)
(straight-use-package 'org)

;;; -------------------------------
;;; UI / utilities
;;; -------------------------------
(straight-use-package 'base16-theme)
(straight-use-package 'catppuccin-theme)
(straight-use-package 'ivy)
(straight-use-package 'counsel)
(straight-use-package 'peep-dired)
(straight-use-package 'fzf)
(straight-use-package 'simple-httpd)
(straight-use-package 'magit)
(straight-use-package 'corfu)
(straight-use-package 'dirvish)
(straight-use-package 'citar)

;;; -------------------------------
;;; Basic UI setup
;;; -------------------------------
(load-theme 'base16-hopscotch t)

(tool-bar-mode -1)
(menu-bar-mode -1)
(scroll-bar-mode -1)
(global-display-line-numbers-mode)
(setq visible-bell t)

;;; -------------------------------
;;; Completion
;;; -------------------------------
(global-corfu-mode 1)
(ivy-mode 1)

;;; -------------------------------
;;; Org-mode
;;; -------------------------------
(use-package org
  :demand t
  :config
  (setq org-startup-with-inline-images t
        org-image-actual-width '(260)
        org-duration-format 'h:mm
        org-agenda-files '("~/.ok/ok")
        org-latex-listings 'minted))

;;; -------------------------------
;;; Citar
;;; -------------------------------
(use-package citar
  :after org
  :custom
  (citar-bibliography '("~/org-roam/biblio.bib")))

;;; -------------------------------
;;; Org-roam (FIXED & WORKING)
;;; -------------------------------
(use-package org-roam
  :demand t
  :after (org emacsql)
  :init
  (setq org-roam-directory (file-truename "~/org-roam"))
  :config
  (org-roam-db-autosync-enable)
  (setq org-roam-capture-templates
        '(("m" "main" plain "%?"
           :if-new (file+head "main/${slug}.org"
                              "#+title: ${title}\n")
           :immediate-finish t
           :unnarrowed t)
          ("r" "reference" plain "%?"
           :if-new (file+head "reference/${title}.org"
                              "#+title: ${title}\n")
