#!/usr/bin/env python3

import os
import sys
from psd_tools import PSDImage
from PIL import Image

def export_psd_layers_to_png(psd_filename):
    current_dir = os.getcwd()
    psd_path = os.path.join(current_dir, psd_filename)
    output_dir = os.path.join(current_dir, 'exported_layers')

    if not os.path.isfile(psd_path):
        print(f"‚ùå File not found: {psd_path}")
        return

    psd = PSDImage.open(psd_path)

    if not os.path.exists(output_dir):
        os.makedirs(output_dir)

    for index, layer in enumerate(psd.descendants()):
        if not layer.is_group() and layer.visible:
            image = layer.composite()
            if image is None:
                continue

            if image.mode != 'RGBA':
                image = image.convert('RGBA')

            layer_name = layer.name.replace('/', '_').replace('\\', '_')
            filename = f"{index:02d}_{layer_name}.png"
            filepath = os.path.join(output_dir, filename)

            image.save(filepath, 'PNG')
            print(f"‚úÖ Exported: {filepath}")

    print("üéâ Done exporting all visible layers.")

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: export-psd-layers <your_file.psd>")
        sys.exit(1)

    export_psd_layers_to_png(sys.argv[1])
