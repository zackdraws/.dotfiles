#!/usr/bin/env fish

function usage
    echo "Usage: $argv[0] <directory_path>"
    echo "This script deletes all files and folders in the specified directory"
    exit 1
end

# Function to format size in dynamic units
function format_size
    set -l bytes $argv[1]

    if test $bytes -lt 1024
        printf "%d B\n" $bytes
    else if test $bytes -lt 1048576
        set -l kb (math "scale=2; $bytes / 1024")
        printf "%.2f KB\n" $kb
    else if test $bytes -lt 1073741824
        set -l mb (math "scale=2; $bytes / (1024 * 1024)")
        printf "%.2f MB\n" $mb
    else
        set -l gb (math "scale=2; $bytes / (1024 * 1024 * 1024)")
        printf "%.2f GB\n" $gb
    end
end

# Check if argument is provided
if test (count $argv) -ne 1
    usage
end

# Get full absolute path
set dir_path (realpath $argv[1])

# Check if directory exists
if not test -d "$dir_path"
    echo "Error: Directory '$dir_path' does not exist"
    exit 1
end

# Get initial size
set initial_size (du -sb "$dir_path" | cut -f1)

# Get file and dir list
set file_list (find "$dir_path" -mindepth 1 -type f)
set dir_list (find "$dir_path" -mindepth 1 -type d)

set file_count (count $file_list)
set dir_count (count $dir_list)

# Show summary
echo "Directory: $dir_path"
echo "Contents to be deleted:"
echo "- Files: $file_count"
echo "- Folders: $dir_count"
echo "- Total size: (format_size $initial_size)"

# First confirmation
echo ""
echo "WARNING: This will delete ALL files and folders in the directory!"
read -P "Type 'yes' to confirm: " answer
if test "$answer" != "yes"
    echo "Operation cancelled"
    exit 0
end

# Second confirmation
read -P "Are you REALLY sure? Type 'yes' again to confirm: " second_answer
if test "$second_answer" != "yes"
    echo "Operation cancelled"
    exit 0
end

# Delete files
for f in $file_list
    rm -f $f
end

# Delete directories in reverse depth order
for d in (printf '%s\n' $dir_list | sort -r)
    rmdir "$d" 2>/dev/null
end

# Final size check
set final_size (du -sb "$dir_path" | cut -f1)
set freed (math "$initial_size - $final_size")

# Final output
echo ""
echo "Deletion completed:"
echo "- Removed $file_count files"
echo "- Removed $dir_count folders"
echo "- Freed (format_size $freed) of space"
