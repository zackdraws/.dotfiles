#!/usr/bin/env bash

# Exit on any error
set -e

echo "📂 Converting all .m4a files in: $(pwd)"
echo "🔖 Metadata will be preserved (if present)"
echo

# Loop through all .m4a files
for AUDIO_FILE in *.m4a; do
    # Skip if no .m4a files
    [ -e "$AUDIO_FILE" ] || { echo "⚠️  No .m4a files found."; exit 0; }

    # Generate output filename
    OUTPUT_FILE="${AUDIO_FILE%.m4a}.mp3"

    echo "🎵 Converting: $AUDIO_FILE → $OUTPUT_FILE"

    ffmpeg -y -i "$AUDIO_FILE" \
        -map_metadata 0 \               # ⬅️ This preserves metadata
        -codec:a libmp3lame \
        -b:a 192k \
        "$OUTPUT_FILE"

    echo "✅ Done: $OUTPUT_FILE"
    echo
done

echo "🏁 All .m4a files converted to .mp3 with metadata preserved!"
