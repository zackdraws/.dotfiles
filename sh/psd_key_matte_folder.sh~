#!/bin/bash



set -e



echo "✨ Creating folders for matte, composite, and line art..."



if ! command -v python3 &>/dev/null; then

    echo "❌ Python 3 required."

    exit 1

fi



mkdir -p matte composite line



python3 - <<EOF

import cv2

import numpy as np

import glob

import os



for file in glob.glob('*.jpg') + glob.glob('*.jpeg'):

    base = os.path.splitext(file)[0]

    matte_output = os.path.join("matte", f"{base}_MATTE.png")

    composite_output = os.path.join("composite", f"{base}.png")

    line_output = os.path.join("line", f"{base}_LINE.png")



    print(f"Processing {file} → Matte: {matte_output}, Composite: {composite_output}, Line: {line_output}")



    image = cv2.imread(file)

    if image is None:

        print(f"Failed to load {file}, skipping.")

        continue



    h, w = image.shape[:2]



    # -------- Extract subject mask --------

    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)

    _, binary = cv2.threshold(gray, 245, 255, cv2.THRESH_BINARY_INV)



    kernel = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (3, 3))

    clean_mask = cv2.morphologyEx(binary, cv2.MORPH_OPEN, kernel, iterations=1)



    contours, _ = cv2.findContours(clean_mask, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

    if not contours:

        print(f"No subject detected in {file}, skipping.")

        continue

    main_contour = max(contours, key=cv2.contourArea)



    subject_mask = np.zeros((h, w), dtype=np.uint8)

    cv2.drawContours(subject_mask, [main_contour], -1, 255, thickness=cv2.FILLED)



    # -------- Create hard-edged matte --------

    kernel_dilate = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (25, 25))

    matte_mask = cv2.dilate(subject_mask, kernel_dilate, iterations=1)

    matte_mask_blurred = matte_mask  # no blur for hard edge



    matte_color_rgb = np.array([204, 255, 255], dtype=np.uint8)  # light yellow (BGR)

    matte_alpha_max = 255  # full opacity



    matte_img = np.zeros((h, w, 4), dtype=np.uint8)

    for c in range(3):

        matte_img[:, :, c] = matte_color_rgb[c]

    matte_img[:, :, 3] = matte_mask_blurred



    cv2.imwrite(matte_output, matte_img)



    # -------- Create alpha for subject (remove white softly) --------

    white_mask = cv2.inRange(image, (245, 245, 245), (255, 255, 255))

    alpha = 255 - white_mask

    alpha = cv2.bitwise_and(alpha, subject_mask)



    image_bgra = cv2.cvtColor(image, cv2.COLOR_BGR2BGRA)

    image_bgra[:, :, 3] = alpha



    # -------- Composite drawing over matte --------

    fg = image_bgra[:, :, :3].astype(np.float32)

    bg = matte_img[:, :, :3].astype(np.float32)

    alpha_fg = (image_bgra[:, :, 3] / 255.0)[:, :, np.newaxis]



    composite_rgb = (fg * alpha_fg + bg * (1 - alpha_fg)).astype(np.uint8)



    final_alpha = np.clip(image_bgra[:, :, 3].astype(np.int16) + matte_img[:, :, 3].astype(np.int16), 0, 255).astype(np.uint8)



    final_img = cv2.merge((composite_rgb, final_alpha))

    cv2.imwrite(composite_output, final_img)



    # -------- Clean line art (black lines on transparent background) --------

    gray_line = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)



    # Adaptive threshold to detect lines (black lines on white)

    line_binary = cv2.adaptiveThreshold(

        gray_line, 255,

        cv2.ADAPTIVE_THRESH_MEAN_C,

        cv2.THRESH_BINARY,

        blockSize=15,

        C=10

    )



    # Invert to get lines white on black for RGBA

    line_bgra = cv2.cvtColor(255 - line_binary, cv2.COLOR_GRAY2BGRA)

    # Use original binary as alpha (lines = opaque)

    line_bgra[:, :, 3] = line_binary



    cv2.imwrite(line_output, line_bgra)



    print(f"✅ Saved matte, composite, and fixed line art for {file}")



EOF



echo "✅ Done! All outputs saved in 'matte/', 'composite/', and 'line/' folders."
